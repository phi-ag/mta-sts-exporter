name: mta-sts-exporter-example

configs:
  mta-sts-exporter:
    content: |
      log:
        json: true

      reports:
        port: 8080
        path: /
        maxbodysize: 1048576
        maxjsonsize: 5242880
        save: true
        savepath: /tmp/reports

      metrics:
        port: 8081
        path: /metrics
        go: false

      policy:
        enabled: true
        content: |
          version: STSv1
          mode: testing
          mx: example.com
          max_age: 86400

volumes:
  mta-sts-reports: {}

x-service: &service
  restart: unless-stopped
  logging:
    driver: journald
    options:
      tag: "{{.Name}}/{{.ID}}"

x-healthcheck: &healthcheck
  start_period: 15s
  start_interval: 1s
  interval: 15s
  timeout: 3s
  retries: 3

services:
  mta-sts-exporter:
    <<: *service
    image: phiag/mta-sts-exporter:1.4.0@sha256:bc1b5c3b240f8188306c70e814f80707553c84dad3e3d0c43a3b42961c53c92f
    # allow rootless docker to write to volume
    user: 0:0
    ports:
      - 127.0.0.1:8080:8080
      - 127.0.0.1:8081:8081
      - "[::1]:8080:8080"
      - "[::1]:8081:8081"
    healthcheck:
      <<: *healthcheck
      test: [CMD, /ko-app/mta-sts-exporter, -health]
    environment:
      CONFIG_PATH: /mta-sts-exporter
    configs:
      - mta-sts-exporter
    volumes:
      - mta-sts-reports:/tmp/reports
